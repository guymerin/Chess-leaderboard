<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Chess Tournament Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html { -webkit-text-size-adjust: 100%; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: calc(20px + env(safe-area-inset-top)) calc(20px + env(safe-area-inset-right)) calc(20px + env(safe-area-inset-bottom)) calc(20px + env(safe-area-inset-left));
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            color: white;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .subtitle {
            color: rgba(255,255,255,0.9);
            font-size: 1.1em;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card-wide {
            grid-column: 1 / -1; /* Span all columns */
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102,126,234,0.4);
        }

        .leaderboard {
            list-style: none;
        }

        .leaderboard li {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .rank {
            font-weight: bold;
            color: #667eea;
            min-width: 30px;
        }

        .player-name {
            flex-grow: 1;
            font-weight: 600;
        }

        .stats {
            color: #666;
            font-size: 0.9em;
        }

        .score {
            font-weight: bold;
            color: #764ba2;
            font-size: 1.2em;
        }

        .grid-container {
            overflow-x: auto;
            margin: -15px;
            padding: 15px;
            -webkit-overflow-scrolling: touch;
        }

        .match-grid {
            border-collapse: collapse;
            width: 100%;
            min-width: 500px;
        }

        .match-grid th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 600;
        }

        .match-grid td {
            padding: 8px;
            text-align: center;
            border: 1px solid #ddd;
            background: white;
        }

        .match-grid tr:first-child th {
            background: #764ba2;
        }

        .match-grid td:first-child {
            background: #f8f9fa;
            font-weight: 600;
        }

        .win { background-color: #d4edda !important; }
        .loss { background-color: #f8d7da !important; }
        .draw { background-color: #fff3cd !important; }
        .empty { background-color: #e9ecef !important; color: #999; }

        .match-count {
            font-size: 0.8em;
            color: #666;
        }

        .players-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .player-tag {
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .player-tag .delete-btn {
            background: rgba(255,255,255,0.3);
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .player-tag .delete-btn:hover {
            background: rgba(255,255,255,0.5);
        }

        .game-history {
            max-height: 300px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .game-item {
            padding: 10px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }

        .game-result {
            flex-grow: 1;
            padding: 0 10px;
        }

        .game-date {
            color: #666;
            font-size: 0.85em;
        }

        .delete-game-btn {
            background: rgba(220, 53, 69, 0.1);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            color: #dc3545;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .delete-game-btn:hover {
            background: rgba(220, 53, 69, 0.2);
        }

        @media (min-width: 768px) {
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }

            h1 {
                font-size: 3em;
            }
        }

        @media (min-width: 1024px) {
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .toggle-view {
            display: inline-block;
            margin-bottom: 15px;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 8px;
        }

        .toggle-view button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: transparent;
            transition: background 0.2s;
            min-height: 44px;
        }

        .toggle-view button.active {
            background: #667eea;
            color: white;
        }

        /* Small-screen optimizations */
        @media (max-width: 480px) {
            h1 { font-size: 2em; }
            .card { padding: 16px; }
            .leaderboard li { flex-wrap: wrap; gap: 8px; padding: 12px; }
            .stats { width: 100%; order: 3; text-align: left; }
            .score { order: 2; }
            .rank { order: 1; }
            .toggle-view { display: flex; flex-wrap: wrap; gap: 6px; padding: 6px; }
            .match-grid { min-width: 420px; }
            input, select { font-size: 16px; }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body { color: #e6e6e6; }
            .card { background: #1f1f1f; box-shadow: 0 10px 30px rgba(0,0,0,0.6); }
            .leaderboard li { background: #262626; }
            .match-grid td { background: #1f1f1f; border-color: #333; }
            .match-grid td:first-child { background: #262626; }
            .game-item { background: #262626; }
            .alert-success { background: #20462a; color: #b8f7c2; border-color: #2b5a36; }
            .alert-error { background: #4a1f24; color: #ffd1d6; border-color: #6a2a31; }
        }

        /* Refresh button */
        .refresh-btn {
            position: fixed;
            bottom: calc(20px + env(safe-area-inset-bottom));
            right: calc(20px + env(safe-area-inset-right));
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 12px rgba(102,126,234,0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: transform 0.2s, box-shadow 0.2s;
            z-index: 1000;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102,126,234,0.6);
        }

        .refresh-btn:active {
            transform: scale(0.95);
        }

        .refresh-btn.spinning {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Mode toggle */
        .mode-toggle {
            text-align: center;
            margin-bottom: 20px;
        }

        .mode-toggle button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            min-height: 44px;
        }

        .mode-toggle button:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .mode-toggle button.active {
            background: white;
            color: #667eea;
            border-color: white;
        }

        .admin-only {
            display: none;
        }

        body.admin-mode .admin-only {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>♟️ Chess Tournament Tracker</h1>
            <p class="subtitle">Track games, view leaderboards, and manage your chess tournament</p>
        </header>

        <!-- Mode Toggle -->
        <div class="mode-toggle">
            <button id="playerModeBtn" class="active" onclick="setMode('player')">👤 Player Mode</button>
            <button id="adminModeBtn" onclick="setMode('admin')">🔧 Admin Mode</button>
        </div>

        <div class="dashboard">
            <!-- Leaderboard -->
            <div class="card">
                <h2>
                    Leaderboard
                    <div class="toggle-view">
                        <button class="active" onclick="showOverallLeaderboard()">Overall</button>
                        <button onclick="showTodayLeaderboard()">Today</button>
                    </div>
                </h2>
                <ul id="leaderboard" class="leaderboard"></ul>
            </div>

            <!-- Add Game Result Section -->
            <div class="card">
                <h2>Record Game Result</h2>
                <div id="addGameAlert" class="alert"></div>
                <div class="form-group">
                    <label for="player1">Player 1</label>
                    <select id="player1"></select>
                </div>
                <div class="form-group">
                    <label for="player2">Player 2</label>
                    <select id="player2"></select>
                </div>
                <div class="form-group">
                    <label for="gameType">Game Type</label>
                    <select id="gameType">
                        <option value="No timer">No timer</option>
                        <option value="1 min game">1 min game</option>
                        <option value="5 min game">5 min game</option>
                        <option value="10 min game">10 min game</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="result">Result</label>
                    <select id="result">
                        <option value="1">Player 1 Wins</option>
                        <option value="0">Draw</option>
                        <option value="-1">Player 2 Wins</option>
                    </select>
                </div>
                <button class="btn" onclick="addGame()">Record Game</button>
            </div>

            <!-- Match Grid -->
            <div class="card card-wide">
                <h2>
                    Match Overview
                    <div class="toggle-view">
                        <button class="active" onclick="showGridView()">Grid View</button>
                        <button onclick="showHistoryView()">Game History</button>
                    </div>
                </h2>
                
                <div id="gridView" class="grid-container">
                    <table id="matchGrid" class="match-grid"></table>
                </div>
                
                <div id="historyView" class="game-history" style="display: none;"></div>
            </div>

            <!-- Players Section (Admin Only) -->
            <div class="card admin-only">
                <h2>Players</h2>
                <div id="playersList" class="players-list"></div>
                
                <h2 style="margin-top: 30px;">Add Player</h2>
                <div id="addPlayerAlert" class="alert"></div>
                <div class="form-group">
                    <label for="playerName">Player Name</label>
                    <input type="text" id="playerName" placeholder="Enter player name" onkeydown="if(event.key==='Enter') addPlayer()">
                </div>
                <button class="btn" onclick="addPlayer()">Add Player</button>
            </div>

            <!-- Data Management Section (Admin Only) -->
            <div class="card admin-only">
                <h2>Data Management</h2>
                <div class="form-group">
                    <button class="btn" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); margin-bottom: 10px;" onclick="exportData()">Export Data (JSON)</button>
                    <label for="fileInput" style="display: block; text-align: center; color: #667eea; font-weight: 600; cursor: pointer; padding: 12px; border: 2px dashed #667eea; border-radius: 8px; margin-bottom: 10px;">
                        📁 Upload JSON File
                    </label>
                    <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="importData(event)">
                    <button class="btn" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);" onclick="clearData()">Clear All Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Refresh Button -->
    <button class="refresh-btn" id="refreshBtn" onclick="manualRefresh()" title="Refresh data from GitHub">
        🔄
    </button>

    <script>
        // Remote sync endpoint (set this to your deployed endpoint URL)
        window.SYNC_ENDPOINT = 'https://ancient-recipe-44cd.guy-merin.workers.dev/';
        // Fetch from raw GitHub URL to bypass Pages CDN caching
        window.RAW_JSON_URL = 'https://raw.githubusercontent.com/guymerin/Chess-leaderboard/main/chess-data.json';
        // Data structure
        let players = [];
        let games = [];
        let currentView = 'grid';
        let leaderboardView = 'overall'; // 'overall' or 'today'
        let currentMode = 'player'; // 'player' or 'admin'

        // Mode management
        function setMode(mode) {
            currentMode = mode;
            localStorage.setItem('chessMode', mode);
            
            // Update body class
            if (mode === 'admin') {
                document.body.classList.add('admin-mode');
            } else {
                document.body.classList.remove('admin-mode');
            }
            
            // Update button states
            document.getElementById('playerModeBtn').classList.toggle('active', mode === 'player');
            document.getElementById('adminModeBtn').classList.toggle('active', mode === 'admin');
            
            console.log(`Switched to ${mode} mode`);
        }

        // Initialize from JSON file and localStorage
        async function init() {
            // Try to load from chess-data.json first
            try {
                const response = await fetch('chess-data.json');
                if (response.ok) {
                    const data = await response.json();
                    if (data.players && Array.isArray(data.players) && data.games && Array.isArray(data.games)) {
                        players = data.players;
                        games = data.games;
                        // Update localStorage with data from JSON
                        localStorage.setItem('chessPlayers', JSON.stringify(players));
                        localStorage.setItem('chessGames', JSON.stringify(games));
                        console.log('Loaded data from chess-data.json');
                    }
                }
            } catch (error) {
                // If chess-data.json doesn't exist, load from localStorage
                console.log('No chess-data.json found, using localStorage');
                const savedPlayers = localStorage.getItem('chessPlayers');
                const savedGames = localStorage.getItem('chessGames');

                if (savedPlayers) {
                    players = JSON.parse(savedPlayers);
                }
                if (savedGames) {
                    games = JSON.parse(savedGames);
                }
            }

            // Add event listeners for player selection changes
            document.getElementById('player1').addEventListener('change', updateResultOptions);
            document.getElementById('player2').addEventListener('change', updateResultOptions);

            // Restore saved mode (default to player mode)
            const savedMode = localStorage.getItem('chessMode') || 'player';
            setMode(savedMode);

            render();

            // Start background refresh so other devices/tabs see changes without reload
            startAutoRefresh();
            setupStorageSync();
        }

        // Update result dropdown options with player names
        function updateResultOptions() {
            const player1 = document.getElementById('player1').value;
            const player2 = document.getElementById('player2').value;
            const resultSelect = document.getElementById('result');

            if (player1 && player2) {
                resultSelect.innerHTML = `
                    <option value="1">${player1} Wins</option>
                    <option value="0">Draw</option>
                    <option value="-1">${player2} Wins</option>
                `;
            } else {
                resultSelect.innerHTML = `
                    <option value="1">Player 1 Wins</option>
                    <option value="0">Draw</option>
                    <option value="-1">Player 2 Wins</option>
                `;
            }
        }

        // Save to localStorage
        function save() {
            localStorage.setItem('chessPlayers', JSON.stringify(players));
            localStorage.setItem('chessGames', JSON.stringify(games));
            scheduleSync();
        }

        // Debounced background sync to remote
        let syncTimer = null;
        function scheduleSync() {
            if (!window.SYNC_ENDPOINT) return;
            clearTimeout(syncTimer);
            syncTimer = setTimeout(syncToRemote, 500);
        }

        let lastSyncTime = 0;
        async function syncToRemote() {
            try {
                const payload = {
                    players,
                    games,
                    updatedAt: new Date().toISOString()
                };
                const res = await fetch(window.SYNC_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    mode: 'cors',
                });
                if (res && res.ok) {
                    lastSyncTime = Date.now();
                    console.log('✓ Synced to GitHub successfully');
                } else {
                    console.error('Remote sync returned non-OK status');
                }
            } catch (err) {
                console.error('Remote sync failed', err);
            }
        }

        // --- Auto refresh from GitHub Pages ---
        const AUTO_REFRESH_INTERVAL_MS = 15000; // 15s
        let autoRefreshTimer = null;

        function startAutoRefresh() {
            clearInterval(autoRefreshTimer);
            autoRefreshTimer = setInterval(fetchRemoteDataIfChanged, AUTO_REFRESH_INTERVAL_MS);
        }

        async function fetchRemoteDataIfChanged() {
            try {
                // Don't fetch if we just synced (avoid overwriting our own changes with stale data)
                const timeSinceLastSync = Date.now() - lastSyncTime;
                if (timeSinceLastSync < 10000) {
                    console.log('Skipping fetch (recently synced)');
                    return;
                }

                // Fetch from raw GitHub to bypass Pages CDN caching
                const url = window.RAW_JSON_URL || ('chess-data.json?ts=' + Date.now());
                const res = await fetch(url, { cache: 'no-store' });
                if (!res.ok) return;
                const data = await res.json();
                if (!data || !Array.isArray(data.players) || !Array.isArray(data.games)) return;

                const localStr = JSON.stringify({ players, games });
                const remoteStr = JSON.stringify({ players: data.players, games: data.games });
                if (remoteStr !== localStr) {
                    console.log('📥 Remote data changed, updating UI from another device...');
                    players = data.players;
                    games = data.games;
                    // Update localStorage WITHOUT triggering another sync
                    localStorage.setItem('chessPlayers', JSON.stringify(players));
                    localStorage.setItem('chessGames', JSON.stringify(games));
                    render();
                }
            } catch (err) {
                console.error('Fetch remote data failed:', err);
            }
        }

        // Keep multiple tabs in sync instantly
        function setupStorageSync() {
            window.addEventListener('storage', (e) => {
                if (e.key === 'chessPlayers' || e.key === 'chessGames') {
                    const savedPlayers = localStorage.getItem('chessPlayers');
                    const savedGames = localStorage.getItem('chessGames');
                    if (savedPlayers) players = JSON.parse(savedPlayers);
                    if (savedGames) games = JSON.parse(savedGames);
                    render();
                }
            });
        }

        // Manual refresh - force fetch from GitHub
        async function manualRefresh() {
            const btn = document.getElementById('refreshBtn');
            btn.classList.add('spinning');
            btn.disabled = true;

            try {
                const url = window.RAW_JSON_URL || ('chess-data.json?ts=' + Date.now());
                const res = await fetch(url, { cache: 'no-store' });
                
                if (!res.ok) {
                    alert('Failed to fetch data from GitHub');
                    return;
                }
                
                const data = await res.json();
                if (!data || !Array.isArray(data.players) || !Array.isArray(data.games)) {
                    alert('Invalid data format');
                    return;
                }

                players = data.players;
                games = data.games;
                localStorage.setItem('chessPlayers', JSON.stringify(players));
                localStorage.setItem('chessGames', JSON.stringify(games));
                render();
                
                console.log('✓ Manually refreshed from GitHub');
                
                // Brief success feedback
                btn.textContent = '✓';
                setTimeout(() => {
                    btn.textContent = '🔄';
                }, 1000);
            } catch (err) {
                console.error('Manual refresh failed:', err);
                alert('Error refreshing data: ' + err.message);
            } finally {
                btn.classList.remove('spinning');
                btn.disabled = false;
            }
        }

        // Add a player
        function addPlayer() {
            const nameInput = document.getElementById('playerName');
            const name = nameInput.value.trim();

            if (!name) {
                showAlert('addPlayerAlert', 'Please enter a player name', 'error');
                return;
            }

            if (players.includes(name)) {
                showAlert('addPlayerAlert', 'Player already exists', 'error');
                return;
            }

            players.push(name);
            save();
            nameInput.value = '';
            showAlert('addPlayerAlert', 'Player added successfully!', 'success');
            render();
        }

        // Add a game result
        function addGame() {
            const player1 = document.getElementById('player1').value;
            const player2 = document.getElementById('player2').value;
            const gameType = document.getElementById('gameType').value;
            const result = parseInt(document.getElementById('result').value);

            if (!player1 || !player2) {
                showAlert('addGameAlert', 'Please select both players', 'error');
                return;
            }

            if (player1 === player2) {
                showAlert('addGameAlert', 'A player cannot play against themselves', 'error');
                return;
            }

            // Automatically use today's date
            const today = new Date().toISOString().split('T')[0];
            const gameId = Date.now().toString();
            games.push({ 
                id: gameId,
                player1, 
                player2, 
                result,
                date: today,
                gameType: gameType
            });
            
            // Sort games by date (newest first)
            games.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            save();
            showAlert('addGameAlert', 'Game recorded successfully!', 'success');
            render();
        }

        // Remove a player
        function removePlayer(playerName) {
            if (confirm(`Are you sure you want to remove ${playerName}? This will also delete all their game records.`)) {
                players = players.filter(p => p !== playerName);
                games = games.filter(g => g.player1 !== playerName && g.player2 !== playerName);
                save();
                render();
            }
        }

        // Render everything
        function render() {
            updatePlayersList();
            updateLeaderboard();
            updateMatchGrid();
            updateGameHistory();
        }

        // Update players list
        function updatePlayersList() {
            const playersList = document.getElementById('playersList');
            const select1 = document.getElementById('player1');
            const select2 = document.getElementById('player2');

            playersList.innerHTML = '';
            select1.innerHTML = '<option value="">Select player...</option>';
            select2.innerHTML = '<option value="">Select player...</option>';

            players.forEach(player => {
                const tag = document.createElement('div');
                tag.className = 'player-tag';
                tag.innerHTML = `
                    ${player}
                    <button class="delete-btn" onclick="removePlayer('${player}')">×</button>
                `;
                playersList.appendChild(tag);

                const option1 = document.createElement('option');
                option1.value = player;
                option1.textContent = player;
                select1.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = player;
                option2.textContent = player;
                select2.appendChild(option2);
            });
        }

        // Update leaderboard
        function updateLeaderboard() {
            const leaderboard = document.getElementById('leaderboard');
            const stats = calculateStats(leaderboardView === 'today');

            let mappedPlayers = players.map(player => ({
                name: player,
                ...stats[player]
            }));

            // When showing today's leaderboard, filter out players who haven't played today
            if (leaderboardView === 'today') {
                mappedPlayers = mappedPlayers.filter(player => player.total > 0);
            }

            const sortedPlayers = mappedPlayers.sort((a, b) => {
                // Sort by points (starts at 50, +1 for win, 0 for draw, -1 for loss), then by win rate
                if (a.points !== b.points) return b.points - a.points;
                if (a.total > 0 && b.total > 0) {
                    return (b.wins / b.total) - (a.wins / a.total);
                }
                return 0;
            });

            leaderboard.innerHTML = '';
            
            if (sortedPlayers.length === 0) {
                const message = leaderboardView === 'today' 
                    ? 'No games played today yet' 
                    : 'No players yet';
                leaderboard.innerHTML = `<li style="text-align: center; color: #999;">${message}</li>`;
            } else {
                sortedPlayers.forEach((player, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span class="rank">#${index + 1}</span>
                        <span class="player-name">${player.name}</span>
                        <span class="stats">W: ${player.wins} D: ${player.draws} L: ${player.losses}</span>
                        <span class="score">${player.points} pts</span>
                    `;
                    leaderboard.appendChild(li);
                });
            }
        }

        // Calculate player statistics
        function calculateStats(onlyToday = false) {
            const stats = {};
            const today = new Date().toISOString().split('T')[0];

            // All players start with 50 points
            players.forEach(player => {
                stats[player] = { wins: 0, draws: 0, losses: 0, total: 0, points: 50 };
            });

            // Filter games by today if needed
            const gamesToProcess = onlyToday ? games.filter(game => game.date === today) : games;

            gamesToProcess.forEach(game => {
                const { player1, player2, result } = game;
                
                if (result === 1) {
                    stats[player1].wins++;
                    stats[player2].losses++;
                    stats[player1].points += 1;  // +1 for win
                    stats[player2].points += -1; // -1 for loss
                } else if (result === -1) {
                    stats[player2].wins++;
                    stats[player1].losses++;
                    stats[player2].points += 1;  // +1 for win
                    stats[player1].points += -1; // -1 for loss
                } else {
                    stats[player1].draws++;
                    stats[player2].draws++;
                    // 0 points for draw (no change)
                }

                stats[player1].total++;
                stats[player2].total++;
            });

            return stats;
        }

        // Update match grid
        function updateMatchGrid() {
            const matchGrid = document.getElementById('matchGrid');
            matchGrid.innerHTML = '';

            if (players.length === 0) {
                return;
            }

            // Count games between each pair
            const gameCounts = {};
            games.forEach(game => {
                const key = `${game.player1} vs ${game.player2}`;
                const reverseKey = `${game.player2} vs ${game.player1}`;
                gameCounts[key] = (gameCounts[key] || 0) + 1;
                gameCounts[reverseKey] = gameCounts[key];
            });

            // Header row
            const headerRow = document.createElement('tr');
            const emptyCell = document.createElement('th');
            headerRow.appendChild(emptyCell);
            
            players.forEach(player => {
                const th = document.createElement('th');
                th.textContent = player;
                headerRow.appendChild(th);
            });
            matchGrid.appendChild(headerRow);

            // Data rows
            players.forEach(player1 => {
                const row = document.createElement('tr');
                const nameCell = document.createElement('td');
                nameCell.textContent = player1;
                row.appendChild(nameCell);

                players.forEach(player2 => {
                    const cell = document.createElement('td');
                    
                    if (player1 === player2) {
                        cell.className = 'empty';
                        cell.textContent = '—';
                    } else {
                        const gameKey = `${player1} vs ${player2}`;
                        const count = gameCounts[gameKey] || 0;
                        
                        // Get results between these two players
                        const playerGames = games.filter(g => 
                            (g.player1 === player1 && g.player2 === player2) ||
                            (g.player1 === player2 && g.player2 === player1)
                        );
                        
                        if (playerGames.length > 0) {
                            // Calculate wins/losses/draws for this pair (from player1's perspective)
                            const wins = playerGames.filter(g => 
                                (g.player1 === player1 && g.result === 1) ||
                                (g.player2 === player1 && g.result === -1)
                            ).length;
                            
                            const draws = playerGames.filter(g => g.result === 0).length;
                            const losses = playerGames.length - wins - draws;
                            
                            let resultText = '';
                            if (wins > losses) {
                                cell.className = 'win';
                                resultText = `${wins}-${losses}${draws > 0 ? '-' + draws : ''}`;
                            } else if (losses > wins) {
                                cell.className = 'loss';
                                resultText = `${wins}-${losses}${draws > 0 ? '-' + draws : ''}`;
                            } else if (draws > 0) {
                                cell.className = 'draw';
                                resultText = `${wins}-${losses}-${draws}`;
                            } else {
                                cell.className = 'draw';
                                resultText = `${wins}-${losses}`;
                            }
                            
                            cell.innerHTML = `<span>${resultText}</span><div class="match-count">(${count})</div>`;
                        } else {
                            cell.className = 'empty';
                            cell.textContent = '';
                        }
                    }
                    
                    row.appendChild(cell);
                });

                matchGrid.appendChild(row);
            });
        }

        // Update game history
        function updateGameHistory() {
            const historyView = document.getElementById('historyView');
            
            if (games.length === 0) {
                historyView.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No games recorded yet</p>';
                return;
            }
            
            historyView.innerHTML = '';
            
            games.forEach(game => {
                const gameItem = document.createElement('div');
                gameItem.className = 'game-item';
                
                let resultText = '';
                if (game.result === 1) {
                    resultText = `${game.player1} <strong>defeated</strong> ${game.player2}`;
                } else if (game.result === -1) {
                    resultText = `${game.player2} <strong>defeated</strong> ${game.player1}`;
                } else {
                    resultText = `${game.player1} <strong>drew with</strong> ${game.player2}`;
                }
                
                const formattedDate = new Date(game.date).toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric' 
                });
                
                const gameTypeDisplay = game.gameType ? ` • ${game.gameType}` : '';
                
                gameItem.innerHTML = `
                    <span class="game-result">${resultText}</span>
                    <span class="game-date">${formattedDate}${gameTypeDisplay}</span>
                    <button class="delete-game-btn" onclick="deleteGame('${game.id}')" title="Delete this game">×</button>
                `;
                
                historyView.appendChild(gameItem);
            });
        }

        // Delete a game
        function deleteGame(gameId) {
            if (confirm('Are you sure you want to delete this game?')) {
                games = games.filter(g => g.id !== gameId);
                save();
                render();
            }
        }

        // Toggle between grid and history view
        function showGridView() {
            document.getElementById('gridView').style.display = 'block';
            document.getElementById('historyView').style.display = 'none';
            document.querySelector('.toggle-view button').classList.add('active');
            document.querySelectorAll('.toggle-view button')[1].classList.remove('active');
        }

        function showHistoryView() {
            document.getElementById('gridView').style.display = 'none';
            document.getElementById('historyView').style.display = 'block';
            document.querySelector('.toggle-view button').classList.remove('active');
            document.querySelectorAll('.toggle-view button')[1].classList.add('active');
        }

        // Show overall leaderboard
        function showOverallLeaderboard() {
            leaderboardView = 'overall';
            const buttons = document.querySelectorAll('.card:first-child .toggle-view button');
            if (buttons.length >= 2) {
                buttons[0].classList.add('active');
                buttons[1].classList.remove('active');
            }
            updateLeaderboard();
        }

        // Show today's leaderboard
        function showTodayLeaderboard() {
            leaderboardView = 'today';
            const buttons = document.querySelectorAll('.card:first-child .toggle-view button');
            if (buttons.length >= 2) {
                buttons[0].classList.remove('active');
                buttons[1].classList.add('active');
            }
            updateLeaderboard();
        }

        // Export data to JSON file
        function exportData() {
            const data = {
                players: players,
                games: games
            };
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'chess-data.json';
            link.click();
            URL.revokeObjectURL(url);
            showAlert('addPlayerAlert', 'Data exported successfully!', 'success');
        }

        // Import data from JSON file
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.players && Array.isArray(data.players) && data.games && Array.isArray(data.games)) {
                        players = data.players;
                        games = data.games;
                        save();
                        render();
                        showAlert('addPlayerAlert', 'Data imported successfully!', 'success');
                    } else {
                        showAlert('addPlayerAlert', 'Invalid JSON format', 'error');
                    }
                } catch (error) {
                    showAlert('addPlayerAlert', 'Error parsing JSON file', 'error');
                }
            };
            reader.readAsText(file);
        }

        // Clear all data
        function clearData() {
            if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                players = [];
                games = [];
                save();
                render();
                showAlert('addPlayerAlert', 'All data cleared', 'success');
            }
        }

        // Show alert
        function showAlert(alertId, message, type) {
            const alert = document.getElementById(alertId);
            alert.textContent = message;
            alert.className = `alert ${type === 'error' ? 'alert-error' : 'alert-success'}`;
            alert.classList.add('show');

            setTimeout(() => {
                alert.classList.remove('show');
            }, 3000);
        }

        // Initialize on load
        init();
    </script>
</body>
</html>